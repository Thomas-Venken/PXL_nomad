---
- name: Uncomment server
  lineinfile:
    path: /etc/consul.d/consul.hcl
    regexp: '#server = true'
    line: server = true
  notify: Uncomment bootstrap

- name: Uncomment bootstrap
  lineinfile:
    path: /etc/consul.d/consul.hcl
    regexp: '#bootstrap_expect=3'
    line: bootstrap_expect=1
  notify: Add bind_addr

- name: Add bind_addr
  lineinfile:
    path: /etc/consul.d/consul.hcl
    line: bind_addr = "192.168.2.15"
    insertafter: '#retry_join'
    create: yes
  notify: edit client_addr

- name: edit client_addr
  lineinfile:
    path: /etc/consul.d/consul.hcl
    regexp: 'client_addr = "0.0.0.0"'
    line: client_addr = "192.168.2.15"
  notify: Add network_interface

- name: Add network_interface
  lineinfile:
    path: /etc/consul.d/consul.hcl
    line: network_interface="eth1"
    insertafter: 'bind_addr = "192.168.2.15"'
    create: yes
  notify: started consul

- name: started consul
  service:
    name: consul
    state: started